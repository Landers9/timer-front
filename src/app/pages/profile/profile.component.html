<!-- src/app/pages/profile/profile.component.html -->

<div class="p-6 space-y-6">
  <!-- Header -->
  <div>
    <h1 class="text-2xl font-semibold text-dark-900">Mon profil</h1>
    <p class="text-sm text-dark-600 mt-1">
      Gérez vos informations personnelles et vos préférences
    </p>
  </div>

  <!-- Success Message -->
  @if (successMessage()) {
  <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start gap-3">
    <svg class="w-5 h-5 text-green-600 shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
    </svg>
    <p class="text-sm text-green-800">{{ successMessage() }}</p>
  </div>
  }

  <!-- Error Message -->
  @if (profileError()) {
  <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
    <svg class="w-5 h-5 text-red-600 shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
    </svg>
    <p class="text-sm text-red-800">{{ profileError() }}</p>
  </div>
  }

  <!-- Loading State -->
  @if (isLoadingProfile()) {
  <div class="flex items-center justify-center py-12">
    <div class="text-center">
      <div class="inline-block w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 text-sm text-dark-600">Chargement du profil...</p>
    </div>
  </div>
  } @else {
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Profile Card -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Profile Card -->
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <div class="flex flex-col items-center text-center">
          <!-- Avatar -->
          <img
            [src]="avatarUrl()"
            [alt]="fullName()"
            class="w-32 h-32 rounded-full border-4 border-primary-500 shadow-lg mb-4"
          />

          <!-- Name & Role -->
          <h2 class="text-xl font-bold text-dark-900">{{ fullName() }}</h2>
          <span [class]="'badge mt-2 ' + getRoleBadge(userProfile().role)">
            {{ getRoleLabel(userProfile().role) }}
          </span>

          <!-- Member Since -->
          <div class="mt-4 pt-4 border-t border-gray-200 w-full">
            <p class="text-xs text-dark-600 mb-1">Membre depuis</p>
            <p class="text-sm font-semibold text-dark-900">
              {{ formatJoinDate(userProfile().joinDate) }}
            </p>
            <p class="text-xs text-dark-600 mt-1">
              Il y a {{ memberSince() }} mois
            </p>
          </div>

          <!-- Actions -->
          <div class="mt-6 w-full space-y-2">
            <button
              *ngIf="!isEditMode()"
              (click)="enterEditMode()"
              class="btn-primary w-full"
              [disabled]="isLoadingProfile()"
            >
              <lucide-angular [img]="EditIcon" class="w-4 h-4"></lucide-angular>
              <span>Modifier le profil</span>
            </button>

            <button
              (click)="openPasswordModal()"
              class="btn-secondary w-full"
              [disabled]="isLoadingProfile()"
            >
              <lucide-angular [img]="LockIcon" class="w-4 h-4"></lucide-angular>
              <span>Changer le mot de passe</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Card -->
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h3 class="text-base font-semibold text-dark-900 mb-4 flex items-center gap-2">
          <lucide-angular [img]="TrendingUpIcon" class="w-5 h-5 text-primary-500"></lucide-angular>
          Statistiques
        </h3>
        <div class="space-y-4">
          <div class="pb-4 border-b border-gray-200">
            <p class="text-xs text-dark-600 mb-1">Heures totales</p>
            <p class="text-lg font-bold text-dark-900">{{ stats().totalHours }}h</p>
          </div>
          <div class="pb-4 border-b border-gray-200">
            <p class="text-xs text-dark-600 mb-1">Moyenne / jour</p>
            <p class="text-lg font-bold text-dark-900">{{ stats().avgHoursPerDay }}h</p>
          </div>
          <div class="pb-4 border-b border-gray-200">
            <p class="text-xs text-dark-600 mb-1">Taux de présence</p>
            <p class="text-lg font-bold text-dark-900">{{ stats().attendanceRate }}%</p>
          </div>
          <div class="pb-4 border-b border-gray-200">
            <p class="text-xs text-dark-600 mb-1">Jours travaillés</p>
            <p class="text-lg font-bold text-dark-900">{{ stats().daysWorked }}</p>
          </div>
          <div>
            <p class="text-xs text-dark-600 mb-1">Retards</p>
            <p class="text-lg font-bold text-dark-900">{{ stats().lateCount }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Profile Details & Activity -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Profile Details -->
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-base font-semibold text-dark-900">
            Informations personnelles
          </h3>
          @if (isEditMode()) {
          <div class="flex gap-2">
            <button
              (click)="cancelEdit()"
              class="btn-secondary"
              [disabled]="isSavingProfile()"
            >
              <lucide-angular [img]="XIcon" class="w-4 h-4"></lucide-angular>
              <span>Annuler</span>
            </button>
            <button
              (click)="saveProfile()"
              class="btn-primary"
              [disabled]="isSavingProfile()"
            >
              @if (isSavingProfile()) {
              <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              } @else {
              <lucide-angular [img]="SaveIcon" class="w-4 h-4"></lucide-angular>
              }
              <span>{{ isSavingProfile() ? 'Enregistrement...' : 'Enregistrer' }}</span>
            </button>
          </div>
          }
        </div>

        <!-- Edit Mode -->
        <form *ngIf="isEditMode()" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="input-label">Prénom *</label>
            <input
              type="text"
              [(ngModel)]="formData().firstName"
              name="firstName"
              required
              class="input-field"
              [disabled]="isSavingProfile()"
            />
          </div>

          <div>
            <label class="input-label">Nom *</label>
            <input
              type="text"
              [(ngModel)]="formData().lastName"
              name="lastName"
              required
              class="input-field"
              [disabled]="isSavingProfile()"
            />
          </div>

          <div>
            <label class="input-label">Email *</label>
            <input
              type="email"
              [(ngModel)]="formData().email"
              name="email"
              required
              class="input-field"
              [disabled]="isSavingProfile()"
            />
          </div>

          <div>
            <label class="input-label">Téléphone</label>
            <input
              type="tel"
              [(ngModel)]="formData().phoneNumber"
              name="phoneNumber"
              class="input-field"
              [disabled]="isSavingProfile()"
            />
          </div>

          <div>
            <label class="input-label">Département</label>
            <input
              type="text"
              [(ngModel)]="formData().department"
              name="department"
              class="input-field"
              [disabled]="isSavingProfile()"
            />
          </div>

          <div>
            <label class="input-label">Poste</label>
            <input
              type="text"
              [(ngModel)]="formData().position"
              name="position"
              class="input-field"
              [disabled]="isSavingProfile()"
            />
          </div>
        </form>

        <!-- View Mode -->
        <div *ngIf="!isEditMode()" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-1">
            <label class="text-xs text-dark-600 font-medium flex items-center gap-2">
              <lucide-angular [img]="UserIcon" class="w-4 h-4"></lucide-angular>
              Prénom
            </label>
            <p class="text-sm text-dark-900 font-medium">{{ userProfile().firstName }}</p>
          </div>

          <div class="space-y-1">
            <label class="text-xs text-dark-600 font-medium flex items-center gap-2">
              <lucide-angular [img]="UserIcon" class="w-4 h-4"></lucide-angular>
              Nom
            </label>
            <p class="text-sm text-dark-900 font-medium">{{ userProfile().lastName }}</p>
          </div>

          <div class="space-y-1">
            <label class="text-xs text-dark-600 font-medium flex items-center gap-2">
              <lucide-angular [img]="MailIcon" class="w-4 h-4"></lucide-angular>
              Email
            </label>
            <p class="text-sm text-dark-900 font-medium">{{ userProfile().email }}</p>
          </div>

          <div class="space-y-1">
            <label class="text-xs text-dark-600 font-medium flex items-center gap-2">
              <lucide-angular [img]="PhoneIcon" class="w-4 h-4"></lucide-angular>
              Téléphone
            </label>
            <p class="text-sm text-dark-900 font-medium">
              {{ userProfile().phoneNumber || 'Non renseigné' }}
            </p>
          </div>

          <div class="space-y-1" *ngIf="userProfile().department">
            <label class="text-xs text-dark-600 font-medium flex items-center gap-2">
              <lucide-angular [img]="BriefcaseIcon" class="w-4 h-4"></lucide-angular>
              Département
            </label>
            <p class="text-sm text-dark-900 font-medium">{{ userProfile().department }}</p>
          </div>

          <div class="space-y-1" *ngIf="userProfile().position">
            <label class="text-xs text-dark-600 font-medium flex items-center gap-2">
              <lucide-angular [img]="BriefcaseIcon" class="w-4 h-4"></lucide-angular>
              Poste
            </label>
            <p class="text-sm text-dark-900 font-medium">{{ userProfile().position }}</p>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h3 class="text-base font-semibold text-dark-900 mb-4 flex items-center gap-2">
          <lucide-angular [img]="ClockIcon" class="w-5 h-5 text-primary-500"></lucide-angular>
          Activité récente
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold text-dark-600 uppercase tracking-wider">
                  Date
                </th>
                <th class="px-6 py-3 text-center text-xs font-semibold text-dark-600 uppercase tracking-wider">
                  Arrivée
                </th>
                <th class="px-6 py-3 text-center text-xs font-semibold text-dark-600 uppercase tracking-wider">
                  Départ
                </th>
                <th class="px-6 py-3 text-center text-xs font-semibold text-dark-600 uppercase tracking-wider">
                  Total
                </th>
                <th class="px-6 py-3 text-center text-xs font-semibold text-dark-600 uppercase tracking-wider">
                  Statut
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              @for (activity of recentActivities(); track activity.id) {
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-900">
                  {{ formatDate(activity.date) }}
                </td>
                <td class="px-6 py-4 text-center whitespace-nowrap text-sm text-dark-900 font-medium">
                  {{ activity.clockIn }}
                </td>
                <td class="px-6 py-4 text-center whitespace-nowrap text-sm text-dark-900 font-medium">
                  {{ activity.clockOut || '-' }}
                </td>
                <td class="px-6 py-4 text-center whitespace-nowrap text-sm text-dark-900 font-semibold">
                  {{ activity.totalHours ? activity.totalHours + 'h' : '-' }}
                </td>
                <td class="px-6 py-4 text-center whitespace-nowrap">
                  <span [class]="'badge ' + getStatusBadgeClass(activity.status)">
                    {{ activity.status === 'completed' ? 'Terminé' : 'En cours' }}
                  </span>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  }
</div>

<!-- Change Password Modal -->
<div
  *ngIf="showPasswordModal()"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  (click)="closePasswordModal()"
>
  <div
    class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-dark-900">Changer le mot de passe</h2>
      <button (click)="closePasswordModal()" class="btn-icon" [disabled]="isChangingPassword()">
        <lucide-angular [img]="XIcon" class="w-5 h-5"></lucide-angular>
      </button>
    </div>

    <form (ngSubmit)="changePassword()" class="p-6 space-y-4">
      <!-- Error Message -->
      @if (passwordError()) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-3 flex items-start gap-2">
        <svg class="w-5 h-5 text-red-600 shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
        <p class="text-sm text-red-800">{{ passwordError() }}</p>
      </div>
      }

      <div>
        <label class="input-label">Mot de passe actuel *</label>
        <input
          type="password"
          [(ngModel)]="passwordForm().currentPassword"
          name="currentPassword"
          required
          class="input-field"
          placeholder="••••••••"
          [disabled]="isChangingPassword()"
        />
      </div>

      <div>
        <label class="input-label">Nouveau mot de passe *</label>
        <input
          type="password"
          [(ngModel)]="passwordForm().newPassword"
          name="newPassword"
          required
          minlength="8"
          class="input-field"
          placeholder="••••••••"
          [disabled]="isChangingPassword()"
        />
        <p class="text-xs text-dark-600 mt-1">Minimum 8 caractères</p>
      </div>

      <div>
        <label class="input-label">Confirmer le mot de passe *</label>
        <input
          type="password"
          [(ngModel)]="passwordForm().confirmPassword"
          name="confirmPassword"
          required
          class="input-field"
          placeholder="••••••••"
          [disabled]="isChangingPassword()"
        />
      </div>

      <div class="flex gap-3 pt-4">
        <button
          type="button"
          (click)="closePasswordModal()"
          class="btn-secondary flex-1"
          [disabled]="isChangingPassword()"
        >
          Annuler
        </button>
        <button
          type="submit"
          class="btn-primary flex-1"
          [disabled]="isChangingPassword()"
        >
          @if (isChangingPassword()) {
          <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          <span>Changement...</span>
          } @else {
          <span>Changer</span>
          }
        </button>
      </div>
    </form>
  </div>
</div>