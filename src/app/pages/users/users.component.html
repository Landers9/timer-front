<!-- src/app/pages/users/users.component.html -->

<div class="p-6 space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-dark-900">Gestion des utilisateurs</h1>
      <p class="text-sm text-dark-600 mt-1">
        {{ filteredUsers().length }} utilisateur(s)
      </p>
    </div>

    <button (click)="openCreateModal()" class="btn-primary">
      <lucide-angular [img]="UserPlusIcon" class="w-5 h-5"></lucide-angular>
      <span>Ajouter un utilisateur</span>
    </button>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg border border-gray-200 p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Search -->
      <div class="relative">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          placeholder="Rechercher par nom ou email..."
          class="search-input"
        />
      </div>

      <!-- Role Filter -->
      <div>
        <select [(ngModel)]="roleFilter" class="input-field">
          <option value="all">Tous les rôles</option>
          <option value="employee">Employés</option>
          <option value="manager">Managers</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-semibold text-dark-600 uppercase tracking-wider">
              Nom complet
            </th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-dark-600 uppercase tracking-wider">
              Email
            </th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-dark-600 uppercase tracking-wider">
              Téléphone
            </th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-dark-600 uppercase tracking-wider">
              Rôle
            </th>
            <th class="px-6 py-3 text-right text-xs font-semibold text-dark-600 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <tr
            *ngFor="let user of filteredUsers()"
            class="hover:bg-gray-50 transition-colors"
          >
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-dark-900">
                {{ getUserFullName(user) }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-dark-600">{{ user.email }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-dark-600">{{ user.phoneNumber }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span [class]="'badge ' + getRoleBadgeClass(user.role)">
                {{ user.role === 'manager' ? 'Manager' : 'Employé' }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex items-center justify-end gap-2">
                <button
                  (click)="openDetailsModal(user)"
                  class="btn-icon"
                  title="Voir les détails"
                >
                  <lucide-angular [img]="EyeIcon" class="w-4 h-4"></lucide-angular>
                </button>
                <button
                  (click)="openEditModal(user)"
                  class="btn-icon"
                  title="Modifier"
                >
                  <lucide-angular [img]="EditIcon" class="w-4 h-4"></lucide-angular>
                </button>
                <button
                  (click)="openDeleteModal(user)"
                  class="btn-icon text-error hover:bg-red-50"
                  title="Supprimer"
                >
                  <lucide-angular [img]="Trash2Icon" class="w-4 h-4"></lucide-angular>
                </button>
              </div>
            </td>
          </tr>

          <!-- Empty State -->
          <tr *ngIf="filteredUsers().length === 0">
            <td colspan="5" class="px-6 py-12 text-center">
              <p class="text-dark-600">Aucun utilisateur trouvé</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Create Modal -->
<div
  *ngIf="showCreateModal()"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  (click)="closeModals()"
>
  <div
    class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-dark-900">Nouvel utilisateur</h2>
      <button (click)="closeModals()" class="btn-icon">
        <lucide-angular [img]="XIcon" class="w-5 h-5"></lucide-angular>
      </button>
    </div>

    <form (ngSubmit)="createUser()" class="p-6 space-y-4">
      <div>
        <label class="input-label">Prénom</label>
        <input
          type="text"
          [(ngModel)]="formData().firstName"
          name="firstName"
          required
          class="input-field"
          placeholder="Jean"
        />
      </div>

      <div>
        <label class="input-label">Nom</label>
        <input
          type="text"
          [(ngModel)]="formData().lastName"
          name="lastName"
          required
          class="input-field"
          placeholder="Dupont"
        />
      </div>

      <div>
        <label class="input-label">Email</label>
        <input
          type="email"
          [(ngModel)]="formData().email"
          name="email"
          required
          class="input-field"
          placeholder="jean.dupont@example.com"
        />
      </div>

      <div>
        <label class="input-label">Téléphone</label>
        <input
          type="tel"
          [(ngModel)]="formData().phoneNumber"
          name="phoneNumber"
          required
          class="input-field"
          placeholder="+33612345678"
        />
      </div>

      <div>
        <label class="input-label">Rôle</label>
        <select [(ngModel)]="formData().role" name="role" class="input-field">
          <option value="employee">Employé</option>
          <option value="manager">Manager</option>
        </select>
      </div>

      <div class="flex gap-3 pt-4">
        <button type="button" (click)="closeModals()" class="btn-secondary flex-1">
          Annuler
        </button>
        <button type="submit" class="btn-primary flex-1">
          Créer
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Modal -->
<div
  *ngIf="showEditModal()"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  (click)="closeModals()"
>
  <div
    class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-dark-900">Modifier l'utilisateur</h2>
      <button (click)="closeModals()" class="btn-icon">
        <lucide-angular [img]="XIcon" class="w-5 h-5"></lucide-angular>
      </button>
    </div>

    <form (ngSubmit)="updateUser()" class="p-6 space-y-4">
      <div>
        <label class="input-label">Prénom</label>
        <input
          type="text"
          [(ngModel)]="formData().firstName"
          name="firstName"
          required
          class="input-field"
        />
      </div>

      <div>
        <label class="input-label">Nom</label>
        <input
          type="text"
          [(ngModel)]="formData().lastName"
          name="lastName"
          required
          class="input-field"
        />
      </div>

      <div>
        <label class="input-label">Email</label>
        <input
          type="email"
          [(ngModel)]="formData().email"
          name="email"
          required
          class="input-field"
        />
      </div>

      <div>
        <label class="input-label">Téléphone</label>
        <input
          type="tel"
          [(ngModel)]="formData().phoneNumber"
          name="phoneNumber"
          required
          class="input-field"
        />
      </div>

      <div>
        <label class="input-label">Rôle</label>
        <select [(ngModel)]="formData().role" name="role" class="input-field">
          <option value="employee">Employé</option>
          <option value="manager">Manager</option>
        </select>
      </div>

      <div class="flex gap-3 pt-4">
        <button type="button" (click)="closeModals()" class="btn-secondary flex-1">
          Annuler
        </button>
        <button type="submit" class="btn-primary flex-1">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<div
  *ngIf="showDeleteModal()"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  (click)="closeModals()"
>
  <div
    class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4"
    (click)="$event.stopPropagation()"
  >
    <div class="p-6">
      <h2 class="text-xl font-semibold text-dark-900 mb-4">Confirmer la suppression</h2>
      <p class="text-dark-600 mb-6">
        Êtes-vous sûr de vouloir supprimer l'utilisateur
        <span class="font-semibold">{{ selectedUser() ? getUserFullName(selectedUser()!) : '' }}</span> ?
        Cette action est irréversible.
      </p>

      <div class="flex gap-3">
        <button (click)="closeModals()" class="btn-secondary flex-1">
          Annuler
        </button>
        <button (click)="deleteUser()" class="btn-primary bg-error hover:bg-red-700 flex-1">
          Supprimer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal with Clock History -->
<div
  *ngIf="showDetailsModal()"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  (click)="closeModals()"
>
  <div
    class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-dark-900">
        Détails de {{ selectedUser() ? getUserFullName(selectedUser()!) : '' }}
      </h2>
      <button (click)="closeModals()" class="btn-icon">
        <lucide-angular [img]="XIcon" class="w-5 h-5"></lucide-angular>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-6">
      <!-- User Info -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-xs text-dark-600 font-medium mb-1">Email</p>
          <p class="text-sm text-dark-900">{{ selectedUser()?.email }}</p>
        </div>
        <div>
          <p class="text-xs text-dark-600 font-medium mb-1">Téléphone</p>
          <p class="text-sm text-dark-900">{{ selectedUser()?.phoneNumber }}</p>
        </div>
        <div>
          <p class="text-xs text-dark-600 font-medium mb-1">Rôle</p>
          <span [class]="'badge ' + getRoleBadgeClass(selectedUser()?.role || 'employee')">
            {{ selectedUser()?.role === 'manager' ? 'Manager' : 'Employé' }}
          </span>
        </div>
      </div>

      <!-- Clock History -->
      <div>
        <h3 class="text-lg font-semibold text-dark-900 mb-4 flex items-center gap-2">
          <lucide-angular [img]="ClockIcon" class="w-5 h-5"></lucide-angular>
          Historique des pointages
        </h3>

        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Date
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Arrivée
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Départ
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Pause Début
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Pause Fin
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Total
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Statut
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-dark-600 uppercase whitespace-nowrap">
                    Évaluation
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr *ngFor="let record of clockRecords()" class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-dark-900 whitespace-nowrap">
                    {{ formatDate(record.date) }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.clockIn }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.clockOut || '-' }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.breakStart || '-' }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.breakEnd || '-' }}
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-dark-900 whitespace-nowrap">
                    {{ record.totalHours ? record.totalHours + 'h' : '-' }}
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap">
                    <span [class]="'badge ' + getStatusBadgeClass(record.status)">
                      {{ record.status === 'completed' ? 'Terminé' : 'En cours' }}
                    </span>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap">
                    <span [class]="'badge ' + getEvaluationBadgeClass(record.evaluation)">
                      {{ getEvaluationLabel(record.evaluation) }}
                    </span>
                  </td>
                </tr>
                <tr *ngFor="let record of clockRecords()" class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-dark-900 whitespace-nowrap">
                    {{ formatDate(record.date) }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.clockIn }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.clockOut || '-' }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.breakStart || '-' }}
                  </td>
                  <td class="px-4 py-3 text-sm text-dark-600 whitespace-nowrap">
                    {{ record.breakEnd || '-' }}
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-dark-900 whitespace-nowrap">
                    {{ record.totalHours ? record.totalHours + 'h' : '-' }}
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap">
                    <span [class]="'badge ' + getStatusBadgeClass(record.status)">
                      {{ record.status === 'completed' ? 'Terminé' : 'En cours' }}
                    </span>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap">
                    <span [class]="'badge ' + getEvaluationBadgeClass(record.evaluation)">
                      {{ getEvaluationLabel(record.evaluation) }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>